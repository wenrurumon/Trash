
rm(list=ls())
setwd('C:\\Users\\WenluluSens\\Downloads')
library(data.table)
df <- read.csv('20170321ICC_sample100.txt')

fun_ct <- function(icc,x=df,row=1){
  x <- x[row,,F]
  c1 <- with(x,ifelse(is.na(roe1)==FALSE&roe1>=0,(roe1-icc)*be/(1+icc),0));
  c2 <- with(x,ifelse(is.na(roe2)==FALSE&roe2>=0&be1>=0,(roe2-icc)*be1/(1+icc)^2,0));
  c3 <- with(x,ifelse(is.na(roe3)==FALSE&roe3>=0&be2>=0,(roe3-icc)*be2/(1+icc)^3,0));
  c4 <- with(x,ifelse(is.na(roe4)==FALSE&roe4>=0&be3>=0,(roe4-icc)*be3/(1+icc)^4,0));
  c5 <- with(x,ifelse(is.na(roe5)==FALSE&roe5>=0&be4>=0,(roe5-icc)*be4/(1+icc)^5,0));
  c6 <- with(x,ifelse(is.na(roe5)==FALSE&roe5>=0&be4>=0&is.na(lt)==FALSE,(roe5-icc)*be4*(1+lt)/((icc-lt)*(1+icc)^5),0));
  exp(x$mc)-x$be-c1-c2-c3-c4-c5-c6
};

#dichotomy
dichotomy <- function(xmin, xmax, itn = 100, cost=cost){
  i <- 0
  while(i<itn){
    i <- i+1
    xmed <- (xmin+xmax)/2
    rlti <- sapply(c(xmin,xmax),cost)
    # print((rlti))
    if(is.na(rlti[1])){rlti[1] <- Inf}
    if(is.na(rlti[2])){rlti[2] <- Inf}
    if(rlti[1]>rlti[2]){
      xmin <- xmed
    } else {
      xmax <- xmed
    }
    if(xmin==xmax){break}
  }
  return(
    c(x=(xmin+xmax)/2,cost=cost((xmin+xmax)/2),itn=i)
  )
}

#dichotomy tree
dt <- function(xmin,xmax,ntree=5,itn=100,cost=cost){
  tree <- sort(c(xmin,xmax,runif(ntree,xmin,xmax)))
  while(ntree>0){
    rlt.tree <- sapply(1:ntree,function(i){
      dichotomy(tree[i],tree[i+1],itn=itn,cost=cost)
    })
    tree <- sort(rlt.tree[1,])
    ntree <- length(tree)-1
  }
  return(rlt.tree[1:2,1])
}

####################################
#Modeling

model <- function(rowi){
  print(rowi)
  cost1 <- function(icc){fun_ct(icc,df,rowi)}
  cost <- function(icc){abs(cost1(icc))}
  test <- dt(xmin=-2,xmax=2,ntree=5,itn=100,cost=cost)
  test
}
sim1 <- sapply(1:nrow(df),model)

######################################

                x         cost
  [1,] -0.08908386 1.776357e-15
  [2,] -0.04005736 8.881784e-16
  [3,]  0.22717442 1.110223e-16
  [4,]  0.22360253 5.551115e-16
  [5,]  0.07595073 6.106227e-16
  [6,]  0.10306766 4.440892e-16
  [7,]  0.19394567 3.330669e-16
  [8,]  0.08914242 5.551115e-17
  [9,]  0.23450774 6.661338e-16
 [10,]  0.16401323 1.554312e-15
 [11,]  0.17450554 9.992007e-16
 [12,]  0.18651548 1.110223e-15
 [13,]  0.18473596 1.776357e-15
 [14,] -2.00000000 7.429617e+01
 [15,] -1.62155659 0.000000e+00
 [16,]  0.09972234 0.000000e+00
 [17,]  0.08342991 7.105427e-15
 [18,] -1.51827917 4.547474e-13
 [19,] -1.48755202 0.000000e+00
 [20,] -1.48211365 0.000000e+00
 [21,] -0.41548694 0.000000e+00
 [22,] -0.42649262 0.000000e+00
 [23,] -1.50087168 0.000000e+00
 [24,] -0.27550588 0.000000e+00
 [25,] -1.54096867 0.000000e+00
 [26,] -0.14589471 0.000000e+00
 [27,] -0.23690747 0.000000e+00
 [28,] -1.49200622 0.000000e+00
 [29,] -0.41669319 0.000000e+00
 [30,] -1.46723139 3.637979e-12
 [31,]  0.12837378 1.136868e-13
 [32,] -0.35094293 0.000000e+00
 [33,]  0.04164568 0.000000e+00
 [34,] -1.53601730 1.818989e-12
 [35,] -0.25047341 0.000000e+00
 [36,] -1.66052479 0.000000e+00
 [37,]  0.02811727 3.552714e-15
 [38,] -0.30151933 0.000000e+00
 [39,] -1.49185019 0.000000e+00
 [40,] -0.39599996 0.000000e+00
 [41,] -0.26432286 0.000000e+00
 [42,] -1.52403575 0.000000e+00
 [43,]  0.06338833 5.684342e-14
 [44,] -0.36738737 0.000000e+00
 [45,] -1.60735245 0.000000e+00
 [46,] -1.50973181 7.275958e-12
 [47,]  0.02674568 3.147977e+01
 [48,] -1.49138985 0.000000e+00
 [49,] -1.47914776 0.000000e+00
 [50,]  0.28323690 9.592327e-14
 [51,] -1.44313680 0.000000e+00
 [52,]  0.05372459 7.993606e-15
 [53,]  0.07546836 1.221245e-14
 [54,]  0.04726278 4.440892e-15
 [55,]  0.09228849 9.769963e-15
 [56,]  0.05354751 1.153330e+01
 [57,]  0.20429265 1.776357e-14
 [58,]  0.19986179 1.776357e-14
 [59,]  0.14165083 1.065814e-14
 [60,]  0.16100181 3.552714e-15
 [61,]  0.20874353 2.131628e-14
 [62,]  0.22156574 4.263256e-14
 [63,]  0.15799163 1.065814e-14
 [64,] -1.60927408 1.818989e-12
 [65,] -0.02360540 1.234284e+02
 [66,] -1.56818285 0.000000e+00
 [67,] -1.79738737 0.000000e+00
 [68,] -1.84305940 0.000000e+00
 [69,]  0.17009323 2.597944e-02
 [70,]  0.61720823 0.000000e+00
 [71,] -2.00000000 6.127023e-01
 [72,]  0.72419406 3.552714e-14
 [73,]  1.67286344 1.126657e+00
 [74,]  1.80053886 5.295737e-01
 [75,]  1.25607974 2.021050e+00
 [76,] -2.00000000 6.381670e+02
 [77,]  0.66472166 0.000000e+00
 [78,]  1.50437697 2.781832e+00
 [79,]  0.74386501 1.610871e+01
 [80,]  1.07502952 6.993718e+00
 [81,]  1.15035527 5.774168e+00
 [82,]  0.77127005 2.297891e+01
 [83,]  1.79938701 2.212206e+00
 [84,] -2.00000000 4.744387e+01
 [85,]  1.62475807 3.048474e+00
 [86,] -2.00000000 1.039625e+01
 [87,] -2.00000000 9.269600e+01
 [88,] -1.62858272 1.421085e-14
 [89,] -1.63384001 0.000000e+00
 [90,] -1.58807151 0.000000e+00
 [91,] -1.60197278 0.000000e+00
 [92,] -1.59399126 2.842171e-14
 [93,] -1.53526993 0.000000e+00
 [94,] -1.44939238 0.000000e+00
 [95,] -1.39853897 0.000000e+00
 [96,]  0.15172454 1.421085e-13
 [97,]  0.11701673 4.973799e-14
 [98,] -0.44809161 0.000000e+00
 [99,] -1.43548482 1.818989e-12
[100,]  0.12233423 1.421085e-13
